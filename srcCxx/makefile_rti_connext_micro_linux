######################################################################
# To compile, type:
# 	make -f makefile_rti_connext_dds_linux
# To compile with the Debug option, use:
#   make -f makefile_rti_connext_dds_linux DEBUG=1
#
# This makefile assumes that your build environment is already correctly
# configured. (For example, the correct version of your compiler and
# linker should be on your PATH.)
#
# You should set the environemnt variable RTIMEHOME to point to where
# RTI Connext Micro is installed.
#
######################################################################

# If undefined in the environment default RTIMEHOME to install dir
ifndef RTIMEHOME
$(error RTIMEHOME not defined)
endif

COMPILER_FLAGS = -m64
LINKER_FLAGS = -m64 -static-libgcc

split_path_name = $(subst /rti_, , $(RTIMEHOME))

version_name = $(lastword $(split_path_name))
common_name = "_shape_main_linux"
executable_name = $(version_name)$(common_name)

RTIMEARCH = x64Linux4gcc7.3.0

ifndef COMPILER
COMPILER = g++
endif

ifndef LINKER
LINKER = g++
endif

SYSLIBS = -ldl -lnsl -lm -lpthread -lrt

ifeq ($(DEBUG),1)
COMPILER_FLAGS += -g -O0
LINKER_FLAGS += -g
LIBS = -L$(RTIMEHOME)/lib/$(RTIMEARCH) \
        -lrti_me_cppzd -lrti_me_discdpdezd -lrti_mezd -lrti_me_rhsmzd -lrti_me_whsmzd $(SYSLIBS)
else
# This option strips the executable symbols
LINKER_FLAGS += -s
LIBS = -L$(RTIMEHOME)/lib/$(RTIMEARCH) \
        -lrti_me_cppz -lrti_me_discdpdez -lrti_mez -lrti_me_rhsmz -lrti_me_whsmz $(SYSLIBS)
endif

DEFINES = -DRTI_UNIX -DRTI_LINUX -DRTI_CONNEXT_MICRO

INCLUDES = -I. -I$(RTIMEHOME)/include -I$(RTIMEHOME)/include/rti_me

OBJDIR := objs/$(RTIMEARCH)_micro

CDRSOURCES     := shape_micro.idl
AUTOGENSOURCES := shape_microSupport.cxx shape_microPlugin.cxx shape_micro.cxx

EXEC          := $(executable_name)
AUTOGENOBJS   := $(addprefix $(OBJDIR)/, $(AUTOGENSOURCES:%.cxx=%.o))

$(OBJDIR)/$(EXEC) : $(AUTOGENSOURCES) $(AUTOGENOBJS) $(OBJDIR)/shape_main.o
	$(LINKER) $(LINKER_FLAGS)   -o $@ $(OBJDIR)/shape_main.o  $(AUTOGENOBJS) $(LIBS)

$(OBJDIR)/%.o : %.cxx
	$(COMPILER) $(COMPILER_FLAGS) -o $@ $(DEFINES) $(INCLUDES) -c  $<

shape_main.cxx : shape_configurator_rti_connext_dds.h

# Generate type-specific sources
$(AUTOGENSOURCES) : $(CDRSOURCES)
	$(RTIMEHOME)/rtiddsgen/scripts/rtiddsgen $(CDRSOURCES) -replace -micro -language C++

$(AUTOGENOBJS): |  objs/$(RTIMEARCH)_micro

objs/$(RTIMEARCH)_micro:
	echo "Making directory objs/$(RTIMEARCH)_micro";
	mkdir -p objs/$(RTIMEARCH)_micro
